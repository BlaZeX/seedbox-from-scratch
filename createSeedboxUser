##################### FIRST LINE
# ---------------------------
#!/bin/bash
# ---------------------------
#
# The Seedbox From Scratch Script
#   By Notos ---> https://github.com/Notos/
#
#
#
# 3.1
#
# you can also use it this way:
#
#    createSeedboxUser <username> <password>
#
#
function getString
{
  local ISPASSWORD=$1
  local LABEL=$2
  local RETURN=$3
  local DEFAULT=$4
  local NEWVAR1=a
  local NEWVAR2=b

  while [ ! $NEWVAR1 = $NEWVAR2 ] || [ -z "$NEWVAR1" ];
  do
    clear
    echo "#"
    echo "#"
    echo "# The Seedbox From Scratch Script"
    echo "#   By Notos ---> https://github.com/Notos/"
    echo "#"
    echo "#"
    echo "#"
    echo

    if [ "$ISPASSWORD" == "YES" ]; then
      read -s -p "$DEFAULT" -p "$LABEL" NEWVAR1
    else
      read -e -i "$DEFAULT" -p "$LABEL" NEWVAR1
    fi

    if [ "$NEWVAR1" == "$DEFAULT" ]
    then
      NEWVAR2=$NEWVAR1
    else
      if [ "$ISPASSWORD" == "YES" ]; then
        echo
        read -s -p "Retype: " NEWVAR2
      else
        read -p "Retype: " NEWVAR2
      fi
    fi
  done
  eval $RETURN=\$NEWVAR1
}
#
#

NEWUSER1=a
NEWUSER2=b
PASSWORD1=a
PASSWORD2=b

if [ $1 ]; then
  NEWUSER1=$1
  NEWUSER2=$1
else
  getString NO  "Username for your seedbox user: " NEWUSER1
fi

if [ $2 ]; then
  PASSWORD1=$2
  PASSWORD2=$2
else
  getString YES "ruTorrent password for user $NEWUSER1: " PASSWORD1
fi

if [ $3 ]
then
  if [ "$3" == "YES" ] || [ "$3" == "NO" ]; then
    CHROOTJAIL1=$3
    CHROOTJAIL2=$3
  else
    getString NO  "User should be in a chroot jail?: " CHROOTJAIL1 YES
  fi
else
  getString NO  "User should be in a chroot jail?: " CHROOTJAIL1 YES
fi

HOMEDIR=/home/$NEWUSER1
if [ "CHROOTJAIL1" == "YES" ]; then
  HOMEDIR=$HOMEDIR/jail/$HOMEDIR/home
fi

# 3.2

set -x verbose

# 3.3

useradd --create-home --home $HOMEDIR --user-group --password $(mkpasswd -s -m md5 $PASSWORD1) --shell /bin/bash $NEWUSER1

if [ "CHROOTJAIL1" == "YES" ]; then
  mkdir -p $HOMEDIR/home
  mkdir -p $HOMEDIR/jail
  chown root:root $HOMEDIR/jail
  jk_init -v $HOMEDIR/jail basicshell editors extendedshell jk_lsh netutils netutils openvpn scp ssh
  jk_jailuser -m -j $HOMEDIR/jail $NEWUSER1
  jk_cp -j $HOMEDIR/jail /lib/x86_64-linux-gnu/libnss_compat.so.2
  cp /usr/sbin/jk_lsh $HOMEDIR/jail/usr/sbin/jk_lsh
  cp /etc/skel/.bashrc $HOMEDIR/jail$HOMEDIR
  sudo perl -pi -e "s/\/usr\/sbin\/jk_lsh/\/bin\/bash/g" $HOMEDIR/jail/etc/passwd
  mkdir -p $HOMEDIR/jail$HOMEDIR
  chown $NEWUSER1: $HOMEDIR/jail$HOMEDIR
  chown $NEWUSER1: $HOMEDIR/jail/$HOMEDIR/home
  cp /usr/sbin/jk_lsh $HOMEDIR/jail/usr/sbin/jk_lsh
  killall jk_socketd
  jk_socketd
fi

# 3.4

echo "" | sudo tee -a /etc/sudoers
echo "$NEWUSER1  ALL=(ALL) ALL" | sudo tee -a /etc/sudoers
addgroup $NEWUSER1 sshdusers

sudo service ssh restart

NEWRPC1=`head -n 1 /etc/scripts/rpc.txt | tail -n 1`
sudo perl -pi -e "s/^$NEWRPC1.*\n$//g" /etc/scripts/rpc.txt

IRSSIPORT=`head -n 1 /etc/scripts/ports.txt | tail -n 1`
sudo perl -pi -e "s/^$IRSSIPORT.*\n$//g" /etc/scripts/ports.txt

SCGIPORT=`head -n 1 /etc/scripts/ports.txt | tail -n 1`
sudo perl -pi -e "s/^$SCGIPORT.*\n$//g" /etc/scripts/ports.txt

NETWORKPORT=`head -n 1 /etc/scripts/ports.txt | tail -n 1`
sudo perl -pi -e "s/^$NETWORKPORT.*\n$//g" /etc/scripts/ports.txt

IRSSIPASSWORD=`makepasswd`

# 12.

#create digest data file
echo -n $NEWUSER1:rutorrent:$PASSWORD1 > /tmp/pass

#remove current password from htpassword
sudo perl -pi -e "s/^$NEWUSER1\:.*\n$//g" /etc/apache2/htpasswd

#create user and password for this new rutorrent user
echo $NEWUSER1:rutorrent:`md5sum /tmp/pass | cut -d" " -f1` | sudo tee -a /etc/apache2/htpasswd

# 19.
sudo cp /etc/scripts/rtorrent.rc.template  $HOMEDIR/.rtorrent.rc > /dev/null

sudo perl -pi -e "s/<username>/$NEWUSER1/g" $HOMEDIR/.rtorrent.rc
sudo perl -pi -e "s/5995/$SCGIPORT/g" $HOMEDIR/.rtorrent.rc
sudo perl -pi -e "s/99888/$NETWORKPORT/g" $HOMEDIR/.rtorrent.rc

sudo chown $NEWUSER1:$NEWUSER1   $HOMEDIR/.rtorrent.rc:$NEWUSER1 $HOMEDIR/.rtorrent.rc

# 20.
sudo mkdir -p $HOMEDIR/downloads/auto
sudo mkdir -p $HOMEDIR/downloads/manual
sudo mkdir -p $HOMEDIR/downloads/watch
sudo mkdir -p $HOMEDIR/downloads/.session
sudo chown -R $NEWUSER1:$NEWUSER1 $HOMEDIR/downloads

# 21.

sudo cp /etc/scripts/rtorrent.conf.template /etc/init/rtorrent.$NEWUSER1.conf
sudo perl -pi -e "s/<username>/$NEWUSER1/g" /etc/init/rtorrent.$NEWUSER1.conf

# 22.
# prepare the tree
sudo mkdir -p /var/www/rutorrent/conf/users/$NEWUSER1/plugins/autodl-irssi
sudo mkdir -p /var/www/rutorrent/conf/users/$NEWUSER1/plugins/diskspace
sudo mkdir -p /var/www/rutorrent/conf/users/$NEWUSER1/plugins/fileupload

echo '<?php $topDirectory = "/home"; ?>' | sudo tee -a /var/www/rutorrent/conf/users/$NEWUSER1/plugins/diskspace/conf.php

#some of those files will be changed later in this script
sudo cp /var/www/rutorrent/conf/access.ini   /var/www/rutorrent/conf/users/$NEWUSER1/
sudo cp /var/www/rutorrent/conf/config.php  /var/www/rutorrent/conf/users/$NEWUSER1/
sudo cp /var/www/rutorrent/conf/plugins.ini   /var/www/rutorrent/conf/users/$NEWUSER1/

# 24.

sudo cp /etc/scripts/rutorrent.conf.users.config.php.template /var/www/rutorrent/conf/users/$NEWUSER1/config.php

sudo perl -pi -e "s/5995/$SCGIPORT/g" /var/www/rutorrent/conf/users/$NEWUSER1/config.php
sudo perl -pi -e "s/RPC123/$NEWRPC1/g" /var/www/rutorrent/conf/users/$NEWUSER1/config.php
sudo perl -pi -e "s/<username>/$NEWUSER1/g" /var/www/rutorrent/conf/users/$NEWUSER1/config.php
sudo perl -pi -e "s/<homedir>/\/home\/$NEWUSER1/g" /var/www/rutorrent/conf/users/$NEWUSER1/config.php

# 25.

sudo cp /etc/scripts/rutorrent.conf.users.plugins.ini.template /var/www/rutorrent/conf/users/$NEWUSER1/plugins.ini

# 29.

sudo rm -R $HOMEDIR/.irssi
sudo mkdir -p $HOMEDIR/.irssi/scripts/autorun
cd $HOMEDIR/.irssi/scripts
sudo wget --no-check-certificate -O autodl-irssi.zip https://sourceforge.net/projects/autodl-irssi/files/autodl-irssi-v1.31.zip/download
sudo unzip -o autodl-irssi.zip
sudo rm autodl-irssi.zip
sudo cp autodl-irssi.pl autorun/
sudo mkdir -p $HOMEDIR/.autodl
sudo touch $HOMEDIR/.autodl/autodl.cfg

sudo cp /etc/scripts/rutorrent.conf.users.plugins.autodl-irssi.conf.php.template  /var/www/rutorrent/conf/users/$NEWUSER1/plugins/autodl-irssi/conf.php
sudo perl -pi -e "s/<PASSWORD>/$IRSSIPASSWORD/g"  /var/www/rutorrent/conf/users/$NEWUSER1/plugins/autodl-irssi/conf.php
sudo perl -pi -e "s/<PORT>/$IRSSIPORT/g" /var/www/rutorrent/conf/users/$NEWUSER1/plugins/autodl-irssi/conf.php

sudo cp /etc/scripts/rutorrent.conf.users.plugins.fileupload.conf.php.template  /var/www/rutorrent/conf/users/$NEWUSER1/plugins/fileupload/config.php > /dev/null
sudo chown -R www-data:www-data /var/www/rutorrent/conf/users/$NEWUSER1/plugins/fileupload/

sudo cp /etc/scripts/home.user.autodl.autodl.cfg.template  $HOMEDIR/.autodl/autodl.cfg

sudo perl -pi -e "s/<PASSWORD>/$IRSSIPASSWORD/g"  $HOMEDIR/.autodl/autodl.cfg
sudo perl -pi -e "s/<PORT>/$IRSSIPORT/g"  $HOMEDIR/.autodl/autodl.cfg
sudo perl -pi -e "s/use Digest\:\:SHA1 qw/use Digest\:\:SHA qw/g" $HOMEDIR/.irssi/scripts/AutodlIrssi/MatchedRelease.pm

sleep 3
sudo su --login --command "screen -d -m -S rtorrent rtorrent" $NEWUSER1
sleep 3
sudo su --login --command "screen -d -m -S irssi irssi" $NEWUSER1

sudo chown -R $NEWUSER1:$NEWUSER1  $HOMEDIR/.autodl
sudo chown -R $NEWUSER1:$NEWUSER1  $HOMEDIR/.irssi

##################### LAST LINE ###########








































































